# Proof-of-Possession

By default, OAuth access tokens are so called bearer tokens. This means they are not bound to a client and anybody who possess the token can use it (compare to cash).

Proof-of-Possession (short PoP) tokens are bound to the client that requested the token. I

Generally, there are two appraoches:

## JWK-Based Proof-of-Possession

Client includes a JWK when making a request to the authorization server for an access token. The JWK consists of the public key of a key pair generated by the client. 

![oauth2-proof-of-possession](imgs/oauth2-proof-of-possession.svg "oauth2-proof-of-possession")

### 1. client puts jwk on `cnf_key` and requests access token from AM server
```bash
curl \
--request POST \
--data "grant_type=client_credentials"\
--data "client_id=myClient" \
--data "client_secret=forgerock" \
--data "cnf_key=ew0KICAgICJKV0siOiB7DQogICAgICAgICJhb
             GciOiAiUlMyNTYiLA0KICAgICAgICAiZSI6IC
             JBUUFCIiwNDQogICAgICAgICJraWQiOiAibXl
             QdWJsaWNKU09OV2ViS2V5Ig0KICAgIH0NCn0=" \
"https://openam.example.com:8443/openam/oauth2/realms/root/access_token"
```

### 2. client extracts `access_token` from AM's response
```json
{
    "access_token":"f08f1fcf-3ecb-4120-820d-fb71e3f51c04",
    "scope":"profile",
    "token_type":"Bearer",
    "expires_in":3599
}
```
and makes a request to resource server asking for resources with present `access_token` and `jwks`.


### 3. resource server verifies access token from AM

Resource server makes a request to AM  given `Authorization` and `access_token` 
```bash
curl \
--request POST \
--header "Authorization: Basic bXlDbGllbnQ6Zm9yZ2Vyb2Nr" \
--data "token=f08f1fcf-3ecb-4120-820d-fb71e3f51c04" \
"https://openam.example.com:8443/openam/oauth2/realms/root/introspect"
```

AM's response:
```json
{
    "active": true,
    "scope": "profile",
    "client_id": "myClient",
    "user_id": "myClient",
    "token_type": "access_token",
    "exp": 1477666348,
    "sub": "myClient",
    "iss": "https://openam.example.com:8443/openam/oauth2/realms/root",
    "cnf": {
        "jwk": {
            "alg": "RS256",
            "e": "AQAB",
            "n": "xea7Tb7rbQ4ZrHNKrg...QFXtJ-didSTtXWCWU1Qrcj0hnDjvkuUFWoSQ_7Q",
            "kty": "RSA",
            "use": "enc",
            "kid": "myPublicJSONWebKey"
        },
    "auth_level": 0
    }
}
```
Resource server uses the public key to cryptographically confirm proof-of-possession of the token by the presenter.

## Certificate-Bound Proof-of-Possession

This ensures that only the client in possession of the private key corresponding to the certificate can use the bearer token to access protected resources. 

![oauth2-proof-of-possession-cert](imgs/oauth2-proof-of-possession-cert.svg "oauth2-proof-of-possession-cert")

Similar to via jwk, certificate-bound proof uses comparable request flow but with certificate as proof rather than jwk.

### 1. To request for an access token

Client request for an access token with its certificates

```bash
curl --request POST \
--cacert AMServer.cer \
--data "client_id=myClient" \
--data "grant_type=client_credentials" \
--data "scope=write" \
--data "response_type=token" \
--cert myClientCertificate.pem \
--key myClientCertificate.key.pem \
"https://openam.example.com:8443/openam/oauth2/realms/root/access_token"
```

### 2. 3. 4. ... The rest are same to that of via jwk